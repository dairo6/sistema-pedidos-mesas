<div class="modal-backdrop" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2 *ngIf="order">Editando Pedido #{{ order.id }}</h2>
      <button class="modal-close-btn" (click)="closeModal()">&times;</button>
    </header>
    
    <main class="modal-body">
      <div class="form-group">
        <label for="customerName">Nombre del Cliente:</label>
        <input type="text" id="customerName" name="customerName" [(ngModel)]="customerName" class="form-control">
      </div>

      <h4>Artículos del Pedido</h4>
      <div *ngIf="editableDetails.length > 0" class="items-list">
        <div *ngFor="let item of editableDetails" class="edit-item">
          <span>{{ item.product.name }}</span>
          <div class="quantity-controls">
            <button (click)="decrementQuantity(item)">-</button>
            <input type="number" [(ngModel)]="item.quantity" min="1" class="quantity-input">
            <button (click)="incrementQuantity(item)">+</button>
          </div>
          <span>Subtotal: ${{ (item.product.price * item.quantity) | number:'1.2-2' }}</span>
          <button class="remove-btn" (click)="removeItem(item.product.id)">Eliminar</button>
        </div>
      </div>
      <p *ngIf="editableDetails.length === 0">No hay artículos en este pedido.</p>

      <div class="total-display">
        <strong>Nuevo Total: ${{ calculateTotal() | number:'1.2-2' }}</strong>
      </div>

      <hr>

      <h4>Añadir Producto</h4>
      <div class="add-product-form">
        <select [(ngModel)]="selectedProductIdToAdd" class="product-select">
          <option [ngValue]="null" disabled>Selecciona un producto...</option>
          <option *ngFor="let product of allProducts" [value]="product.id">
            {{ product.name }} (${{ product.price }})
          </option>
        </select>
        <button (click)="addProduct()" [disabled]="!selectedProductIdToAdd" class="btn-add">Añadir</button>
      </div>
    </main>

    <footer class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">Cancelar</button>
      <button class="btn-save" (click)="saveChanges()" [disabled]="isLoading">
        <span *ngIf="!isLoading">Guardar Cambios</span>
        <app-loading-spinner *ngIf="isLoading"></app-loading-spinner>
      </button>
    </footer>
  </div>
</div>